stages:
  - lint
  - test
  - security
  - build
  - deploy-staging
  - deploy-production
  - health-check

variables:
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"
  REGISTRY: $CI_REGISTRY
  IMAGE_TAG: $CI_REGISTRY_IMAGE:$CI_COMMIT_REF_SLUG

# Code Quality and Linting
lint:
  stage: lint
  image: node:20
  before_script:
    - if [ -f package.json ]; then npm ci; fi
  script:
    - |
      if [ -f package.json ]; then
        npm run lint || echo "Linting skipped or failed"
      fi
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

lint-python:
  stage: lint
  image: python:3.11
  before_script:
    - if [ -f requirements.txt ]; then pip install -r requirements.txt flake8 black isort; fi
  script:
    - |
      if [ -f requirements.txt ]; then
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics || true
        black --check . || true
      fi
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# Unit Tests
unit-tests:
  stage: test
  image: node:20
  services:
    - postgres:15
    - mysql:8.0
    - redis:7-alpine
  variables:
    POSTGRES_DB: test_db
    POSTGRES_USER: test_user
    POSTGRES_PASSWORD: test_password
    MYSQL_DATABASE: test_db
    MYSQL_ROOT_PASSWORD: test_password
  before_script:
    - if [ -f package.json ]; then npm ci; fi
  script:
    - |
      if [ -f package.json ]; then
        npm test -- --coverage || true
      fi
  coverage: '/Lines\s*:\s*(\d+\.\d+)%/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage/cobertura-coverage.xml
    paths:
      - coverage/
    expire_in: 30 days
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

unit-tests-python:
  stage: test
  image: python:3.11
  services:
    - postgres:15
    - mysql:8.0
    - redis:7-alpine
  variables:
    POSTGRES_DB: test_db
    POSTGRES_USER: test_user
    POSTGRES_PASSWORD: test_password
    MYSQL_DATABASE: test_db
    MYSQL_ROOT_PASSWORD: test_password
  before_script:
    - if [ -f requirements.txt ]; then pip install -r requirements.txt pytest pytest-cov pytest-mock; fi
  script:
    - |
      if [ -f requirements.txt ]; then
        pytest tests/unit/ -v --cov=. --cov-report=xml --cov-report=html || true
      fi
  coverage: '/TOTAL.*\s+(\d+%)$/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml
    paths:
      - htmlcov/
    expire_in: 30 days
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# Integration Tests
integration-tests:
  stage: test
  image: node:20
  services:
    - postgres:15
    - mysql:8.0
    - redis:7-alpine
  variables:
    POSTGRES_DB: test_db
    POSTGRES_USER: test_user
    POSTGRES_PASSWORD: test_password
    MYSQL_DATABASE: test_db
    MYSQL_ROOT_PASSWORD: test_password
    DATABASE_URL: postgresql://test_user:test_password@postgres:5432/test_db
    MYSQL_URL: mysql://root:test_password@mysql:3306/test_db
    REDIS_URL: redis://redis:6379
  before_script:
    - if [ -f package.json ]; then npm ci; fi
    - if [ -f requirements.txt ]; then pip install -r requirements.txt pytest; fi
  script:
    - |
      if [ -f package.json ]; then
        npm run test:integration || true
      fi
      if [ -f requirements.txt ]; then
        pytest tests/integration/ -v || true
      fi
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH || $CI_COMMIT_BRANCH == "develop"

# Security Scanning
security-scan:
  stage: security
  image: 
    name: aquasec/trivy:latest
    entrypoint: [""]
  variables:
    TRIVY_NO_PROGRESS: "true"
    TRIVY_EXIT_CODE: "0"
  script:
    - trivy fs --severity HIGH,CRITICAL --format gitlab --exit-code 0 .
  allow_failure: true
  artifacts:
    reports:
      sast: gl-sast-report.json
    paths:
      - gl-sast-report.json
    expire_in: 30 days
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

dependency-scan:
  stage: security
  image: node:20
  before_script:
    - if [ -f package.json ]; then npm ci; fi
  script:
    - |
      if [ -f package.json ]; then
        npm audit --audit-level=moderate || true
      fi
  allow_failure: true
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# Build Docker Image
build:
  stage: build
  image: docker:24
  services:
    - docker:24-dind
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - |
      docker build \
        --build-arg BUILD_DATE=$(date -u +'%Y-%m-%dT%H:%M:%SZ') \
        --build-arg VCS_REF=$CI_COMMIT_SHA \
        --build-arg VERSION=$CI_COMMIT_TAG \
        -t $CI_REGISTRY_IMAGE:$CI_COMMIT_REF_SLUG \
        -t $CI_REGISTRY_IMAGE:latest \
        .
    - docker push $CI_REGISTRY_IMAGE:$CI_COMMIT_REF_SLUG
    - docker push $CI_REGISTRY_IMAGE:latest
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH || $CI_COMMIT_BRANCH == "develop"

# Deploy to Staging
deploy-staging:
  stage: deploy-staging
  image: alpine:latest
  before_script:
    - apk add --no-cache curl
  script:
    - echo "Deploying to staging environment..."
    # Add your deployment commands here
    # Example: kubectl apply -f k8s/staging/
    # Or: terraform apply -auto-approve -var-file=staging.tfvars
  environment:
    name: staging
    url: https://staging.medical-lab.example.com
  variables:
    ENV: staging
  only:
    - develop
  when: manual

# Deploy to Production
deploy-production:
  stage: deploy-production
  image: alpine:latest
  before_script:
    - apk add --no-cache curl
  script:
    - echo "Deploying to production environment..."
    # Add your deployment commands here
    # Example: kubectl apply -f k8s/production/
    # Or: terraform apply -auto-approve -var-file=production.tfvars
  environment:
    name: production
    url: https://medical-lab.example.com
  variables:
    ENV: production
  only:
    - main
  when: manual
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# Health Check
health-check:
  stage: health-check
  image: alpine:latest
  before_script:
    - apk add --no-cache curl
  script:
    - |
      if [ "$CI_COMMIT_REF_NAME" == "main" ]; then
        URL="https://medical-lab.example.com/health"
      else
        URL="https://staging.medical-lab.example.com/health"
      fi
      
      echo "Checking health endpoint: $URL"
      response=$(curl -s -o /dev/null -w "%{http_code}" $URL || echo "000")
      
      if [ "$response" == "200" ]; then
        echo "Health check passed!"
        exit 0
      else
        echo "Health check failed with status: $response"
        exit 1
      fi
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH || $CI_COMMIT_BRANCH == "develop"
  needs:
    - job: deploy-production
      optional: true
    - job: deploy-staging
      optional: true

